@page "/reservar/{servicioId:int}"

@inject HttpClient Http
@inject NavigationManager Nav

@if (servicio == null)
{
    <div class="alert alert-info">Cargando información del servicio...</div>
}
else
{
    <div class="form-card">

        <h2 class="form-title">Nueva reserva de servicio</h2>
        <div class="glow-line"></div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label"><strong>Fecha de la reserva</strong></label>
                <input type="date" class="form-control" @bind="formFecha" required />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label"><strong>Dirección de origen</strong></label>
                <input class="form-control" @bind="formOrigen" required />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label"><strong>Dirección destino</strong></label>
                <input class="form-control" @bind="formDestino" required />
            </div>

            <div class="col-md-12 mb-3">
                <label class="form-label"><strong>Notas</strong></label>
                <textarea class="form-control" rows="3" @bind="formNotas"></textarea>
            </div>
        </div>

        <button class="submit-btn p-2" @onclick="GuardarServicio">
            Guardar Reserva
        </button>
    </div>

}

@code {

    [Parameter] public int servicioId { get; set; }

    ServicioDTO? servicio;

    DateTime? formFecha;
    string? formOrigen;
    string? formDestino;
    string? formNotas;

    protected override async Task OnInitializedAsync()
    {
        // Obtener el resultado del API
        var resultado = await Http.GetFromJsonAsync<List<SolicitudServicioDTO>>(
            $"api/SolicitudServicio/{servicioId}"
        );

        if (resultado == null || resultado.Count == 0)
        {
            Console.WriteLine("No se encontró servicio");
            return;
        }

        var item = resultado.First();

        // Mapear SOLO lo que necesitas
        servicio = new ServicioDTO
        {
            TipoTransporte = item.TipoTransporteId.ToString(),
            NombreConductor = item.Usuario?.Nombre,
            TelefonoConductor = item.Usuario?.Telefono,
            Vehiculo = $"{item.Transporte?.Marca} {item.Transporte?.Modelo}",
            Descripcion = $"Solicitud número {item.Id}",
            Valor = 0  // si tu API envía precio, cámbialo aquí
        };
    }


    async Task GuardarServicio()
    {
        var nuevaReserva = new ServicioDT
        {
            LatitudOrigen = 6.25184,        
            LongitudOrigen = -75.563591,
            LatitudDestino = 6.265845,
            LongitudDestino = -75.576598,
            UsuarioId = 1001,
            MetodoPagoId = 1001,
            TipoTransporteId = 1001,
            FechaSolicitud = DateTime.Now
        };

        
        var response = await Http.PostAsJsonAsync("api/SolicitudServicio", nuevaReserva);

        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("Reserva creada correctamente.");
            Nav.NavigateTo("/");
        }
        else
        {
            var errorTexto = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"Error al guardar reserva: {response.StatusCode} - {errorTexto}");
        }
    }


    void Volver()
    {
        Nav.NavigateTo("/");
    }

    public class ServicioDT
    {
        public double LatitudOrigen { get; set; }
        public double LongitudOrigen { get; set; }
        public double LatitudDestino { get; set; }
        public double LongitudDestino { get; set; }
        public int UsuarioId { get; set; }
        public int MetodoPagoId { get; set; }
        public int TipoTransporteId { get; set; }
        public DateTime FechaSolicitud { get; set; }

 
    }

    public class SolicitudServicioDTO
    {
        public UsuarioDTO? Usuario { get; set; }
        public TransporteDTO? Transporte { get; set; }
        public MetodoPagoDTO? MetodoPago { get; set; }

        public int Id { get; set; }
        public double LatitudOrigen { get; set; }
        public double LongitudOrigen { get; set; }
        public double LatitudDestino { get; set; }
        public double LongitudDestino { get; set; }
        public int TipoTransporteId { get; set; }
        public int UsuarioId { get; set; }
        public int MetodoPagoId { get; set; }
        public DateTime FechaSolicitud { get; set; }
    }

    public class UsuarioDTO
    {
        public int Id { get; set; }
        public string? Nombre { get; set; }
        public string? Documento { get; set; }
        public string? Telefono { get; set; }
    }

    public class TransporteDTO
    {
        public int Id { get; set; }
        public string? Matricula { get; set; }
        public string? Placa { get; set; }
        public string? Marca { get; set; }
        public string? Modelo { get; set; }
    }

    public class MetodoPagoDTO
    {
        public int Id { get; set; }
        public string? Descripcion { get; set; }
    }
    public class ServicioDTO
    {
        public string? TipoTransporte { get; set; }
        public string? NombreConductor { get; set; }
        public string? Vehiculo { get; set; }
        public string? TelefonoConductor { get; set; }
        public string? Descripcion { get; set; }
        public decimal Valor { get; set; }
    }
}
